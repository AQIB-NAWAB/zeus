{"version":3,"names":["NativeModules","FaradayApi","LitApi","LndApi","LoopApi","PoolApi","snakeKeysToCamel","createRpc","LncCredentialStore","log","DEFAULT_CONFIG","namespace","serverHost","LNC","constructor","lncConfig","_defineProperty","keyHex","debug","credentials","localKey","remoteKey","config","Object","assign","_namespace","credentialStore","pairingPhrase","isPaired","lnd","loop","pool","faraday","lit","LncModule","initLNC","isConnected","status","expiry","Date","isReadOnly","hasPerms","permission","connect","connected","registerLocalPrivCreateCallback","onLocalPrivCreate","registerRemoteKeyReceiveCallback","onRemoteKeyReceive","registerAuthDataCallback","onAuthData","error","connectServer","disconnect","request","method","Promise","resolve","reject","reqJSON","JSON","stringify","invokeRPC","response","rawRes","parse","res","Error","subscribe","initListener"],"sources":["lnc.ts"],"sourcesContent":["import { NativeModules } from 'react-native';\nimport {\n    FaradayApi,\n    LitApi,\n    LndApi,\n    LoopApi,\n    PoolApi,\n    snakeKeysToCamel\n} from '@lightninglabs/lnc-core';\nimport { createRpc } from './api/createRpc';\nimport { CredentialStore, LncConfig } from './types/lnc';\nimport LncCredentialStore from './util/credentialStore';\nimport { log } from './util/log';\n\n/** The default values for the LncConfig options */\nconst DEFAULT_CONFIG = {\n    namespace: 'default',\n    serverHost: 'mailbox.terminal.lightning.today:443'\n} as Required<LncConfig>;\n\nexport default class LNC {\n    _namespace: string;\n    credentials: CredentialStore;\n\n    lnd: LndApi;\n    loop: LoopApi;\n    pool: PoolApi;\n    faraday: FaradayApi;\n    lit: LitApi;\n\n    constructor(lncConfig?: LncConfig) {\n        // merge the passed in config with the defaults\n        const config = Object.assign({}, DEFAULT_CONFIG, lncConfig);\n\n        this._namespace = config.namespace;\n\n        if (config.credentialStore) {\n            this.credentials = config.credentialStore;\n        } else {\n            this.credentials = new LncCredentialStore(config.pairingPhrase);\n            // don't overwrite an existing serverHost if we're already paired\n            if (!this.credentials.isPaired)\n                this.credentials.serverHost = config.serverHost;\n            if (config.pairingPhrase)\n                this.credentials.pairingPhrase = config.pairingPhrase;\n        }\n\n        this.lnd = new LndApi(createRpc, this);\n        this.loop = new LoopApi(createRpc, this);\n        this.pool = new PoolApi(createRpc, this);\n        this.faraday = new FaradayApi(createRpc, this);\n        this.lit = new LitApi(createRpc, this);\n        NativeModules.LncModule.initLNC(this._namespace);\n    }\n\n    onLocalPrivCreate = (keyHex: string) => {\n        log.debug('local private key created: ' + keyHex);\n        this.credentials.localKey = keyHex;\n    };\n\n    onRemoteKeyReceive = (keyHex: string) => {\n        log.debug('remote key received: ' + keyHex);\n        this.credentials.remoteKey = keyHex;\n    };\n\n    onAuthData = (keyHex: string) => {\n        log.debug('auth data received: ' + keyHex);\n    };\n\n    async isConnected() {\n        return await NativeModules.LncModule.isConnected(this._namespace);\n    }\n\n    async status() {\n        return await NativeModules.LncModule.status(this._namespace);\n    }\n\n    async expiry() {\n        const expiry = await NativeModules.LncModule.expiry(this._namespace);\n        return new Date(expiry * 1000);\n    }\n\n    async isReadOnly() {\n        return await NativeModules.LncModule.isReadOnly(this._namespace);\n    }\n\n    async hasPerms(permission: string) {\n        return await NativeModules.LncModule.hasPerms(\n            this._namespace,\n            permission\n        );\n    }\n\n    /**\n     * Connects to the LNC proxy server\n     * @returns a promise that resolves when the connection is established\n     */\n    async connect() {\n        // do not attempt to connect multiple times\n        const connected = await this.isConnected();\n        if (connected) return;\n\n        NativeModules.LncModule.registerLocalPrivCreateCallback(\n            this._namespace,\n            this.onLocalPrivCreate\n        );\n        NativeModules.LncModule.registerRemoteKeyReceiveCallback(\n            this._namespace,\n            this.onRemoteKeyReceive\n        );\n        NativeModules.LncModule.registerAuthDataCallback(\n            this._namespace,\n            this.onAuthData\n        );\n\n        const { pairingPhrase, localKey, remoteKey, serverHost } =\n            this.credentials;\n\n        // connect to the server\n        const error = await NativeModules.LncModule.connectServer(\n            this._namespace,\n            serverHost,\n            false,\n            pairingPhrase,\n            localKey,\n            remoteKey\n        );\n\n        return error;\n    }\n\n    /**\n     * Disconnects from the proxy server\n     */\n    disconnect() {\n        NativeModules.LncModule.disconnect(this._namespace);\n    }\n\n    /**\n     * Emulates a GRPC request but uses the mobile client instead to communicate with the LND node\n     * @param method the GRPC method to call on the service\n     * @param request The GRPC request message to send\n     */\n    request<TRes>(method: string, request?: object): Promise<TRes> {\n        return new Promise((resolve, reject) => {\n            log.debug(`${method} request`, request);\n            const reqJSON = JSON.stringify(request || {});\n            NativeModules.LncModule.invokeRPC(\n                this._namespace,\n                method,\n                reqJSON,\n                (response: string) => {\n                    try {\n                        const rawRes = JSON.parse(response);\n                        const res = snakeKeysToCamel(rawRes);\n                        log.debug(`${method} response`, res);\n                        resolve(res as TRes);\n                    } catch (error) {\n                        log.debug(`${method} raw response`, response);\n                        reject(new Error(response));\n                        return;\n                    }\n                }\n            );\n        });\n    }\n\n    /**\n     * Subscribes to a GRPC server-streaming endpoint and executes the `onMessage` handler\n     * when a new message is received from the server\n     * @param method the GRPC method to call on the service\n     * @param request the GRPC request message to send\n     * @param onMessage the callback function to execute when a new message is received\n     * @param onError the callback function to execute when an error is received\n     */\n    subscribe(method: string, request?: object): string {\n        log.debug(`${method} request`, request);\n        const reqJSON = JSON.stringify(request || {});\n        NativeModules.LncModule.initListener(this._namespace, method, reqJSON);\n        return method;\n    }\n}\n"],"mappings":"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"}